#!/bin/sh

set -e

if test "`id -u`" != 0; then
  if which sudo 2>/dev/null 1>&2; then
    echo "This needs to be run as root, trying sudo" 1>&2
    exec sudo "$0" "$@"
  else
    echo "This needs to be run as root" 1>&2
    exit 2
  fi
fi

if echo "$0" |grep -q /; then
  BASE=`dirname "$0"`
else
  echo "Cannot determine base directory" 1>&2
  exit 2
fi

. $BASE/common.sh

apt-get install \
  zsh sudo man-db openssh-server smartmontools dnsutils \
  git curl make \
  zip unzip

if ! is_headless; then
  apt-get install \
    gitk libvte9 scite \
    firefox-esr xpdf evince \
    xinit xauth openbox xscreensaver \
    xfonts-terminus

  if install_mm; then
    apt-get install mplayer alsa-utils
  fi
fi

echo '%sudo ALL=(ALL:ALL) NOPASSWD:ALL' > /etc/sudoers.d/sudo-group
chmod 0400 /etc/sudoers.d/sudo-group

apt-get install nvi
update-alternatives --set editor /usr/bin/nvi

chsh -s /bin/zsh root

if have_user me; then
  chsh -s /bin/zsh me
  usermod -a -G sudo me
fi

if have_user w; then
  chsh -s /bin/zsh w
fi
