#!/bin/sh

set -e

if test "`id -u`" != 0; then
  if which sudo 2>/dev/null 1>&2; then
    echo "This needs to be run as root, trying sudo" 1>&2
    exec sudo "$0" "$@"
  else
    echo "This needs to be run as root" 1>&2
    exit 2
  fi
fi

if echo "$0" |grep -q /; then
  BASE=`dirname "$0"`
else
  echo "Cannot determine base directory" 1>&2
  exit 2
fi

. $BASE/common.sh

apt-get install \
  openntpd smartmontools openssh-server \
  zsh sudo man-db dnsutils \
  git curl make \
  zip unzip

if is_headful; then
  apt-get install \
    gitk libvte9 scite feh \
    firefox-esr xpdf evince chromium \
    xinit xauth openbox xscreensaver \
    xfonts-terminus

  if install_mm; then
    apt-get install mplayer alsa-utils youtube-dl
  fi
fi

echo '%sudo ALL=(ALL:ALL) NOPASSWD:ALL' > /etc/sudoers.d/sudo-group
chmod 0400 /etc/sudoers.d/sudo-group

apt-get install nvi
update-alternatives --set editor /usr/bin/nvi

chsh -s /bin/zsh root

if have_user me; then
  chsh -s /bin/zsh me
  usermod -a -G sudo me
fi

if have_user w; then
  chsh -s /bin/zsh w
fi

if is_laptop; then
  apt-get install \
    acpi pm-utils hdparm wireless-tools wpasupplicant \
    nfs-client

  if lspci |grep -q 'Intel.*PRO/Wireless.*AGN'; then
    apt-get install firmware-iwlwifi
  fi

  if ! grep -q '^apm = 255' /etc/hdparm.conf; then
    sed -i -e s/'^apm =/#apm =/' /etc/hdparm.conf
    echo apm = 255 |tee -a /etc/hdparm.conf
  fi
fi
