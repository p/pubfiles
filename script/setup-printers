#!/usr/bin/env ruby

puts "Usage: setup-printers local-name remote-uri path-to-ppd"

if ARGV.empty? || ARGV.length % 3 != 0
  raise 'Bad usage'
end

require 'fileutils'
require 'erb'

system("/etc/init.d/cups stop")

printer_count = ARGV.length / 3

ppd_paths = {}

config = <<-EOT
# Printer configuration file for CUPS v2.3.3op2
# Written by cupsd
# DO NOT EDIT THIS FILE WHEN CUPSD IS RUNNING
NextPrinterId #{printer_count+1}
EOT

index = 1
until ARGV.empty?
  local_name, remote_uri, ppd_path = ARGV.shift(3)

  config << <<-EOT
<DefaultPrinter #{local_name}>
PrinterId 1
UUID urn:uuid:acc2ce8e-1111-2222-eeee-bd24ab2e7ea7
AuthInfoRequired none
Info
Location
DeviceURI #{remote_uri}
State Idle
StateTime 1632086640
ConfigTime 1628925695
Type 6
Accepting Yes
Shared No
JobSheets none none
QuotaPeriod 0
PageLimit 0
KLimit 0
OpPolicy default
ErrorPolicy retry-job
</DefaultPrinter>
EOT

  ppd_paths[local_name] = ppd_path
  index += 1
end

path = '/etc/cups/printers.conf'
STDERR.puts("Writing #{path}")

if File.exist?(path)
  FileUtils.mv(path, "#{path}.#{Time.now.strftime('%Y%d%m-%H%M%S')}")

  File.open(path, 'w') do |f|
    f << config
  end
end

dir = '/etc/cups/ppd'
FileUtils.mkdir_p(dir)

ppd_paths.each do |name, src|
  FileUtils.cp(src, File.join(dir, name))
end
