#!/usr/bin/env ruby

require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: launch-chromium [-u user] profile"

  opts.on("-u", "--user USER", "Launch as given user") do |v|
    options[:user] = v
  end
end.parse!

profile, = ARGV

if profile.nil?
  raise "Usage: launch-chromium [-u user] profile"
end

target_user_slug = options[:user] || profile
target_user = if target_user_slug.start_with?('br-')
  target_user_slug
else
  target_user = "br-#{target_user_slug}"
end

target_xauthority_path = "/home/#{target_user}/.Xauthority"
puts `xauth list | sed -e 's/^/add /' | sudo -u "#{target_user}" env HOME=/home/"#{target_user}" XAUTHORITY=#{target_xauthority_path} xauth`

profile_arg = if profile == target_user_slug
  ''
else
  "XDG_HOME=/home/#{target_user}/#{profile}"
end

exec("sudo -u #{target_user} env #{profile_arg} DISPLAY=#{ENV.fetch('DISPLAY')} XAUTHORITY=#{target_xauthority_path} chromium")
