#!/usr/bin/env ruby

require_relative '../lib/ruby/format_helpers'
require_relative '../lib/ruby/disk/smart_info'
require 'time'
require 'rugged'

include FormatHelpers

repo = Rugged::Repository.new('.')

ARGV.each do |file_path|
  puts file_path
  walker = Rugged::Walker.new(repo)
  walker.push(repo.head.target.oid)
  history = []
  walker.each do |commit|
    commit.diff.each_delta do |delta|
      history.push(commit.oid) if delta.new_file[:path] == file_path
    end
  end

  prev = nil
  history.each do |oid|
    blob = repo.blob_at(oid, file_path)
    #p blob.methods-Object.methods
    info = Disk::SmartInfo.new(blob.text)
    if prev
      puts "At #{prev.time}, for previous #{friendly_time(prev.time - info.time)}:"
      puts "#{friendly_size(prev.read_bytes_processed - info.read_bytes_processed)} read"
      puts "#{prev.read_corrected - info.read_corrected} read errors corrected (#{'%.3f' % ((prev.read_corrected - info.read_corrected) / ((prev.read_bytes_processed - info.read_bytes_processed).to_f / 1024**3))} per GB)"
      puts "#{prev.read_correction_invocations - info.read_correction_invocations} read correction invocations (#{'%.3f' % ((prev.read_correction_invocations - info.read_correction_invocations) / ((prev.read_bytes_processed - info.read_bytes_processed).to_f / 1024**3))} per GB)"
      puts "#{friendly_size(prev.write_bytes_processed - info.write_bytes_processed)} written"
      puts "#{prev.write_corrected - info.write_corrected} write errors corrected (#{'%.3f' % ((prev.write_corrected - info.write_corrected) / ((prev.write_bytes_processed - info.write_bytes_processed).to_f / 1024**3))} per GB)"
      puts "#{prev.write_correction_invocations - info.write_correction_invocations} write correction invocations (#{'%.3f' % ((prev.write_correction_invocations - info.write_correction_invocations) / (info.write_bytes_processed.to_f / 1024**3))} per GB)"
      # Seagate drives do not report verify counts
      if info.verify_bytes_processed
        puts "#{friendly_size(prev.verify_bytes_processed - info.verify_bytes_processed)} verified"
        puts "#{prev.verify_corrected - info.verify_corrected} verify errors corrected (#{'%.3f' % ((prev.verify_corrected - info.verify_corrected) / ((prev.verify_bytes_processed - info.verify_bytes_processed).to_f / 1024**3))} per GB)"
        puts "#{prev.verify_correction_invocations - info.verify_correction_invocations} verify correction invocations (#{'%.3f' % ((prev.read_correction_invocations - info.read_correction_invocations) / (info.read_bytes_processed.to_f / 1024**3))} per GB)"
      end
      puts

      #p info
    end
    prev = info
  end
end
