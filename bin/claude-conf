#!/usr/bin/env ruby

require 'json'
require 'yaml'
require 'optparse'

# Path to the Claude configuration file
CLAUDE_CONFIG_PATH = File.expand_path('~/.claude.json')

# Parse command line options
options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: extract_claude_auth.rb [options]"

  opts.on("-f", "--state-file FILE", "State file path for YAML (default: stdout for extract, stdin for restore)") do |file|
    options[:state_file] = file
  end

  opts.on("-a", "--auth", "Export authentication-related parameters") do
    options[:auth] = true
  end

  opts.on("-r", "--restore", "Restore mode: merge settings from YAML file into Claude config") do
    options[:restore] = true
  end

  opts.on("--reset-install-method", "Reset the installMethod field in Claude config") do
    options[:reset_install_method] = true
  end

  opts.on("-h", "--help", "Prints this help") do
    puts opts
    exit
  end
end.parse!

# Handle reset-install-method option
if options[:reset_install_method]
  begin
    config_content = File.read(CLAUDE_CONFIG_PATH)
    config_data = JSON.parse(config_content)
  rescue Errno::ENOENT
    $stderr.puts "Error: #{CLAUDE_CONFIG_PATH} not found"
    exit 1
  rescue JSON::ParserError => e
    $stderr.puts "Error parsing JSON from #{CLAUDE_CONFIG_PATH}: #{e.class}: #{e}"
    exit 1
  end

  # Remove installMethod field
  if config_data.key?('installMethod')
    old_value = config_data.delete('installMethod')

    # Write updated config back
    begin
      File.write(CLAUDE_CONFIG_PATH, JSON.pretty_generate(config_data))
      $stderr.puts "Install method reset successfully!"
      $stderr.puts "Removed: installMethod = #{old_value}"
      $stderr.puts "Updated config: #{CLAUDE_CONFIG_PATH}"
    rescue => e
      $stderr.puts "Error writing config file to #{CLAUDE_CONFIG_PATH}: #{e.class}: #{e}"
      exit 1
    end
  else
    $stderr.puts "No installMethod field found in config"
  end

  # Exit if this was the only operation requested
  exit 0 unless options[:restore] || options[:auth] || options[:state_file]
end

if options[:restore]
  # Restore mode: read YAML and merge into config
  begin
    if options[:state_file]
      yaml_path = File.expand_path(options[:state_file])
      yaml_content = File.read(yaml_path)
    else
      yaml_content = $stdin.read
    end
    auth_data = YAML.load(yaml_content)
  rescue Errno::ENOENT => e
    $stderr.puts "Error: #{e.message}"
    exit 1
  rescue Psych::SyntaxError => e
    $stderr.puts "Error parsing YAML: #{e.class}: #{e}"
    exit 1
  end

  # Read existing config
  begin
    config_content = File.read(CLAUDE_CONFIG_PATH)
    config_data = JSON.parse(config_content)
  rescue Errno::ENOENT
    $stderr.puts "Error: #{CLAUDE_CONFIG_PATH} not found"
    exit 1
  rescue JSON::ParserError => e
    $stderr.puts "Error parsing JSON from #{CLAUDE_CONFIG_PATH}: #{e.class}: #{e}"
    exit 1
  end

  # Merge authentication data back into config
  config_data['primaryApiKey'] = auth_data['api_key'] if auth_data['api_key']
  config_data['oauthAccount'] = auth_data['oauth_account'] if auth_data['oauth_account']
  config_data['userID'] = auth_data['user_id'] if auth_data['user_id']
  config_data['customApiKeyResponses'] = auth_data['custom_api_key_responses'] if auth_data['custom_api_key_responses']

  # Write updated config back
  begin
    File.write(CLAUDE_CONFIG_PATH, JSON.pretty_generate(config_data))
    $stderr.puts "Data restored successfully!"
    $stderr.puts "Updated config: #{CLAUDE_CONFIG_PATH}"
  rescue => e
    $stderr.puts "Error writing config file to #{CLAUDE_CONFIG_PATH}: #{e.class}: #{e}"
    exit 1
  end

  # Display summary
  $stderr.puts "\nRestored data:"
  $stderr.puts "- API Key: #{auth_data['api_key'] ? '[RESTORED]' : '[SKIPPED]'}"
  $stderr.puts "- OAuth Account: #{auth_data['oauth_account'] ? auth_data['oauth_account']['emailAddress'] : '[SKIPPED]'}"
  $stderr.puts "- User ID: #{auth_data['user_id'] ? '[RESTORED]' : '[SKIPPED]'}"
else
  # Extract mode: read config and write to YAML
  begin
    config_content = File.read(CLAUDE_CONFIG_PATH)
    config_data = JSON.parse(config_content)
  rescue Errno::ENOENT
    $stderr.puts "Error: #{CLAUDE_CONFIG_PATH} not found"
    exit 1
  rescue JSON::ParserError => e
    $stderr.puts "Error parsing JSON from #{CLAUDE_CONFIG_PATH}: #{e.class}: #{e}"
    exit 1
  end

  # Extract authentication data (only if -a option is specified)
  auth_data = {}
  if options[:auth]
    auth_data = {
      'api_key' => config_data['primaryApiKey'],
      'oauth_account' => config_data['oauthAccount'],
      'user_id' => config_data['userID'],
      'custom_api_key_responses' => config_data['customApiKeyResponses']
    }
  end

  # Write to YAML file or stdout
  begin
    if options[:state_file]
      yaml_path = File.expand_path(options[:state_file])
      File.write(yaml_path, auth_data.to_yaml)
      $stderr.puts "Data extracted successfully!"
      $stderr.puts "Output saved to: #{yaml_path}"
    else
      puts auth_data.to_yaml
    end
  rescue => e
    $stderr.puts "Error writing YAML: #{e.class}: #{e}"
    exit 1
  end
end
