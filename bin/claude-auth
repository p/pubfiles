#!/usr/bin/env ruby

require 'json'
require 'yaml'
require 'optparse'

# Path to the Claude configuration file
CLAUDE_CONFIG_PATH = File.expand_path('~/.claude.json')

# Parse command line options
options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: extract_claude_auth.rb [options]"

  opts.on("-f", "--state-file FILE", "State file path for YAML (default: stdout for extract, stdin for restore)") do |file|
    options[:state_file] = file
  end

  opts.on("-r", "--restore", "Restore mode: merge settings from YAML file into Claude config") do
    options[:restore] = true
  end

  opts.on("-h", "--help", "Prints this help") do
    puts opts
    exit
  end
end.parse!

if options[:restore]
  # Restore mode: read YAML and merge into config
  begin
    if options[:state_file]
      yaml_path = File.expand_path(options[:state_file])
      yaml_content = File.read(yaml_path)
    else
      yaml_content = $stdin.read
    end
    auth_data = YAML.load(yaml_content)
  rescue Errno::ENOENT => e
    $stderr.puts "Error: #{e.message}"
    exit 1
  rescue Psych::SyntaxError => e
    $stderr.puts "Error parsing YAML: #{e.class}: #{e}"
    exit 1
  end

  # Read existing config
  begin
    config_content = File.read(CLAUDE_CONFIG_PATH)
    config_data = JSON.parse(config_content)
  rescue Errno::ENOENT
    $stderr.puts "Error: #{CLAUDE_CONFIG_PATH} not found"
    exit 1
  rescue JSON::ParserError => e
    $stderr.puts "Error parsing JSON from #{CLAUDE_CONFIG_PATH}: #{e.class}: #{e}"
    exit 1
  end

  # Merge authentication data back into config
  config_data['primaryApiKey'] = auth_data['api_key'] if auth_data['api_key']
  config_data['oauthAccount'] = auth_data['oauth_account'] if auth_data['oauth_account']
  config_data['userID'] = auth_data['user_id'] if auth_data['user_id']
  config_data['customApiKeyResponses'] = auth_data['custom_api_key_responses'] if auth_data['custom_api_key_responses']

  # Write updated config back
  begin
    File.write(CLAUDE_CONFIG_PATH, JSON.pretty_generate(config_data))
    $stderr.puts "Authentication data restored successfully!"
    $stderr.puts "Updated config: #{CLAUDE_CONFIG_PATH}"
  rescue => e
    $stderr.puts "Error writing config file to #{CLAUDE_CONFIG_PATH}: #{e.class}: #{e}"
    exit 1
  end

  # Display summary
  $stderr.puts "\nRestored data:"
  $stderr.puts "- API Key: #{auth_data['api_key'] ? '[RESTORED]' : '[SKIPPED]'}"
  $stderr.puts "- OAuth Account: #{auth_data['oauth_account'] ? auth_data['oauth_account']['emailAddress'] : '[SKIPPED]'}"
  $stderr.puts "- User ID: #{auth_data['user_id'] ? '[RESTORED]' : '[SKIPPED]'}"
else
  # Extract mode: read config and write to YAML
  begin
    config_content = File.read(CLAUDE_CONFIG_PATH)
    config_data = JSON.parse(config_content)
  rescue Errno::ENOENT
    $stderr.puts "Error: #{CLAUDE_CONFIG_PATH} not found"
    exit 1
  rescue JSON::ParserError => e
    $stderr.puts "Error parsing JSON from #{CLAUDE_CONFIG_PATH}: #{e.class}: #{e}"
    exit 1
  end

  # Extract authentication data
  auth_data = {
    'api_key' => config_data['primaryApiKey'],
    'oauth_account' => config_data['oauthAccount'],
    'user_id' => config_data['userID'],
    'custom_api_key_responses' => config_data['customApiKeyResponses']
  }

  # Write to YAML file or stdout
  begin
    if options[:state_file]
      yaml_path = File.expand_path(options[:state_file])
      File.write(yaml_path, auth_data.to_yaml)
      $stderr.puts "Authentication data extracted successfully!"
      $stderr.puts "Output saved to: #{yaml_path}"
    else
      puts auth_data.to_yaml
    end
  rescue => e
    $stderr.puts "Error writing YAML: #{e.class}: #{e}"
    exit 1
  end

  # Display summary (only when writing to file)
  if options[:state_file]
    $stderr.puts "\nExtracted data:"
    $stderr.puts "- API Key: #{auth_data['api_key'] ? '[PRESENT]' : '[MISSING]'}"
    $stderr.puts "- OAuth Account: #{auth_data['oauth_account'] ? auth_data['oauth_account']['emailAddress'] : '[MISSING]'}"
    $stderr.puts "- User ID: #{auth_data['user_id'] ? '[PRESENT]' : '[MISSING]'}"
  end
end
